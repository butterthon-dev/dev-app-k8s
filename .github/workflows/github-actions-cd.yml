name: GitHub Actions

on:
  repository_dispatch:
    types:
      - update-yml

jobs:
  update-yml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      
      - name: Set Env
        run: |
          echo GITHUB_REF"=${{ github.event.client_payload.ref }}" >> $GITHUB_ENV
          echo GITHUB_SHA"=${{ github.event.client_payload.github_sha }}" >> $GITHUB_ENV

      - name: Update staging yml
        if: ${{ env.GITHUB_REF }} == 'master'
        uses: mikefarah/yq@master
        with:
          cmd: IMAGE_TAG=' asia-northeast1-docker.pkg.dev/cloud-learn-dev/dev-app-img-repository/sample-image:${{ env.GITHUB_SHA }}' yq eval '.spec.template.spec.containers[].image = env(IMAGE_TAG)' -i overlays/staging/patches/development.yml

      - name: commit & push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="master"
          git config user.name butterthon-dev
          git config user.email butterthon@gmail.com
          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
